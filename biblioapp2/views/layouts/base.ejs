<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Sistema de gestión bibliotecaria BiblioApp">
  
  <!-- Preconexión para CDNs -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <title><%= title ? `${title} | BiblioApp` : 'BiblioApp - Gestión Bibliotecaria' %></title>

  <!-- Bootstrap CSS optimizado -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"
    onerror="this.onerror=null;this.href='/css/bootstrap.min.css';">

  <!-- Bootstrap Icons con fallback local -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    onerror="this.onerror=null;this.href='/css/bootstrap-icons.css'">

  <!-- Estilos personalizados con preload -->
  <link rel="preload" href="/css/styles.css" as="style">
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Favicon moderno -->
  <link rel="icon" href="/img/favicon.ico" sizes="any">
  <link rel="icon" href="/img/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <!-- Metatags para redes sociales -->
  <meta property="og:title" content="<%= title || 'BiblioApp' %>">
  <meta property="og:description" content="Sistema de gestión bibliotecaria">
  <meta property="og:image" content="/img/og-image.jpg">
</head>
<body class="d-flex flex-column min-vh-100">
  <%- include('../partials/navbar') %>

  <!-- Contenedor principal con loading estratégico -->
  <main class="container my-4 flex-grow-1">
    <% if (success) { %>
      <div class="alert alert-success alert-dismissible fade show mb-4">
        <div class="d-flex align-items-center">
          <i class="bi bi-check-circle-fill me-2"></i>
          <div><%= success %></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-danger alert-dismissible fade show mb-4">
        <div class="d-flex align-items-center">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <div><%= error %></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    <% } %>

    <%- body %>
  </main>

  <%- include('../partials/footer') %>

  <!-- Scripts optimizados -->
  <script>
    // Carga diferida de Bootstrap JS
    document.addEventListener('DOMContentLoaded', function() {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
      script.integrity = 'sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL';
      script.crossOrigin = 'anonymous';
      script.onerror = function() {
        // Fallback local si CDN falla
        const fallbackScript = document.createElement('script');
        fallbackScript.src = '/js/bootstrap.bundle.min.js';
        document.body.appendChild(fallbackScript);
      };
      document.body.appendChild(script);
    });
  </script>

  <!-- Scripts personalizados con carga diferida -->
  <script defer src="/js/main.js"></script>
  
  <!-- Soporte para temas oscuros -->
  <script>
    if (localStorage.getItem('theme') === 'dark' || 
        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.setAttribute('data-bs-theme', 'dark');
    }
  </script>
</body>
</html>